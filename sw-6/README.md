![](../assets/swift-source-file.jpg)

[Переход на Главную страницу](../README.md)
<hr><hr>

# Разработка приложения на основе языка Swift.
## Урок 11 и 12: Хранение данных
### Описание
- Хранение данных
    - Core Data
    - Relationships
    - NSFetchedResultsController
    - Keychain
    - UserDefaults
- Паттерны
    - Декоратор
    - Абстрактная фабрика
    - Одиночка
- Уведомления

<br>
<hr><hr>

## Задание
### 1. Темы оформления

Добавить темы в свое приложение. 
Для пользователя должен быть доступен выбор темы, сделать это он может в профиле, там где сейчас отображается имя и аватарка. 
У пользователя должен быть выбор минимум между 3 темами, причем при смене темы должен меняться не только фон в приложении, 
но и цвет текста, цвет фона, цвет ячеек и так далее.

Добавить темы в приложение:
- Пользователь должен иметь возможность **выбрать тему** в профиле (где отображается имя и аватар).
- Должно быть доступно **минимум 3 темы**.
- При смене темы изменяются:
    - фон приложения,
    - цвет текста,
    - цвет ячеек и т.д.

##
### 2. Использование Core Data

Добавить в приложение Core Data. 
Теперь необходимо сохранять друзей и группы. 
Когда пользователь переходит к списку друзей или групп - ему сначала должны показываться данные из Core Data, 
затем, когда придет ответ на запрос - отображаются новые данные, а также эти данные обновляются в Core Data. 
Если в ответ на запрос приходит ошибка, то необходимо отобразить ее пользователю, например, используя UIAlertController 
и показать данные из Core Data с пометкой, на какой момент времени эти данные актуальны.

- Необходимо сохранять **друзей** и **группы**.
- При переходе к спискам сначала отображаются данные из **Core Data**.
- После получения ответа от сервера:
    - отображаются новые данные;
    - Core Data обновляется.
- В случае ошибки:
    - показать ошибку через `UIAlertController`;
    - отобразить данные из Core Data с пометкой времени актуальности.

##
### 3. Обновление списка друзей

Добавить возможность обновить список друзей. 
Например, добавить кнопку, по нажатию на которую происходит запрос в сеть на получение списка друзей 
или отправлять запрос, если пользователь “потянет” за таблицу (то есть беседы листаем движением пальца снизу вверх, 
а запрос будет отправляться при движении сверху вниз, находясь на самом верху таблицы). 
После получения данных необходимо их отобразить, а также обновить в Core Data.

- Добавить кнопку обновления списка друзей;
- Или реализовать pull-to-refresh (движение сверху вниз в таблице).
- После получения ответа:
    - отобразить новые данные;
    - обновить Core Data.

##
### 4. Индикация обновления

Если обновление списка друзей инициировано пользователем, 
то необходимо на время получения данных показать пользователю, 
что данные обновляются (посмотрите в сторону UIActivityIndicatorView или UIRefreshControl).

- Если обновление запущено пользователем, показать индикатор загрузки:
    - `UIActivityIndicatorView` или `UIRefreshControl`.

##
### 5. Переход к профилю друга

Необходимо добавить возможность перейти в профиль друга. То есть по клику на ячейку друга необходимо переходить в его профиль. Выглядеть он должен точно так же, как и профиль пользователя, но без возможности сменить тему.

- По нажатию на ячейку друга открывать его профиль.
- Экран профиля:
    - аналогичен экрану профиля пользователя;
    - **без возможности смены темы**.

##
## Ожидаемый результат

| № | Описание                                                                                               |
|--:|--------------------------------------------------------------------------------------------------------|
| 1 | В приложении реализован выбор тем (минимум 3), меняется фон, цвет текста, цвет ячеек и т.д.            |
| 2 | Подключена Core Data. Данные сначала из неё, затем обновляются по ответу сервера. Ошибки отображаются. |
| 3 | Добавлена возможность обновить список друзей (кнопка или pull-to-refresh).                             |
| 4 | При обновлении отображается индикатор загрузки.                                                        |
| 5 | Реализован переход к профилю друга по нажатию.                                                         |

##

<br>
<hr><hr>

## Решение задания
# Инструкция по выполнению задания
## Краткое содержание

Работе с локальным хранением данных и паттернами проектирования в iOS-приложениях. 
Изучаются механизмы **Core Data**, **UserDefaults**, **Keychain**, использование `NSFetchedResultsController`, 
шаблоны проектирования (Декоратор, Абстрактная фабрика, Одиночка), а также **уведомления через UNUserNotificationCenter**.  
В домашнем задании необходимо применить Core Data для хранения друзей и групп, реализовать смену тем оформления, 
обновление данных, индикаторы загрузки и навигацию к профилю друга.

##
## Задание и реализация
### 1. Темы оформления

**Цель:** добавить поддержку 3 и более тем оформления.  
**Реализация:**

- В экране профиля (где аватар и имя) добавить элемент управления (например, `UISegmentedControl` или `UIPickerView`) для выбора темы.
- Создать перечисление `AppTheme` с параметрами: `.light`, `.dark`, `.custom`.
- Сохранить текущую тему через `UserDefaults`:

```swift
UserDefaults.standard.set("dark", forKey: "app_theme")
```

- При загрузке приложения применить сохраненную тему к `UINavigationBar`, `UITableView`, цветам текста, фона и ячеек.

##
### 2. Использование Core Data

**Цель:** использовать Core Data для хранения друзей и групп.  
**Шаги:**

1. Создать Data Model с сущностями `Friend` и `Group`, добавить необходимые поля.
2. В коде использовать `NSFetchRequest<Friend>` и `NSManagedObjectContext`.
3. При переходе к списку друзей:
  - отобразить данные из Core Data.
  - затем выполнить сетевой запрос.
  - при успешном ответе:
    - обновить данные на экране;
    - сохранить в Core Data.
  - при ошибке:
    - показать `UIAlertController`;
    - указать дату последнего обновления.

##
### 3. Обновление списка друзей

**Цель:** пользователь может вручную инициировать обновление списка.

**Реализация:**

- Способ 1: Добавить кнопку обновления (`UIBarButtonItem`) в `UINavigationBar`.
- Способ 2: Использовать `UIRefreshControl` и `UITableViewController`:

```swift
let refreshControl = UIRefreshControl()
refreshControl.addTarget(self, action: #selector(refreshData), for: .valueChanged)
tableView.refreshControl = refreshControl
```

- Метод `refreshData` должен инициировать сетевой запрос, а после - обновить Core Data и UI.

##
### 4. Индикация обновления

**Цель:** визуально показывать пользователю, что данные обновляются.  
**Реализация:**

- Использовать `UIActivityIndicatorView` для загрузки при нажатии кнопки.
- Или использовать `UIRefreshControl`, как в предыдущем пункте.
- Необходимо остановить индикатор после получения ответа:

```swift
refreshControl.endRefreshing()
activityIndicator.stopAnimating()
```

##
### 5. Переход к профилю друга

**Цель:** переход по ячейке друга к его профилю, что аналогично экрану профиля пользователя.

**Реализация:**

- В `didSelectRowAt indexPath:` создать экран профиля друга:

```swift
let friendVC = FriendProfileViewController()
friendVC.friend = selectedFriend
navigationController?.pushViewController(friendVC, animated: true)
```

- На экране друга отключить возможность менять тему:

```swift
themeSelector.isHidden = true
```

##
## Результат

| № | Требование                                                       |
|--:|------------------------------------------------------------------|
| 1 | Темы оформления: минимум 3, изменение фона, текста и ячеек       |
| 2 | Core Data используется для хранения и отображения данных         |
| 3 | Список друзей можно обновлять вручную (кнопка / pull-to-refresh) |
| 4 | Отображается индикатор обновления при загрузке                   |
| 5 | Реализован экран профиля друга                                   |

**Проект реализует**:
- Использование CoreData для хранения профилей друзей
- Темы приложения: светлая, тёмная и пользовательская темы
- Структуру MVC: модели, контроллеры, темы
- Поддержку отображения и редактирования профиля друга

##
### Используемые технологии и паттерны

- `Core Data` для хранения и обновления списка друзей и групп
- `UserDefaults` для хранения темы
- `UIAlertController` для вывода ошибок
- `UIRefreshControl` и `UIActivityIndicatorView` - для индикации загрузки
- `NSFetchedResultsController` - для работы с таблицами
- Шаблоны проектирования: **Одиночка**, **Декоратор**, **Абстрактная фабрика**

##
### Пример кода для добавления данных в Core Data

```swift
func saveFriend(name: String) {
    let friend = Friend(context: context)
    friend.name = name
    do {
        try context.save()
    } catch {
        print("Error saving: \(error)")
    }
}
```

<br><br>

[Переход на Главную страницу](../README.md)
<hr><hr>